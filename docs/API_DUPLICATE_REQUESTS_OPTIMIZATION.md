# Оптимизация дублирования запросов к API

## Резюме

Проведен анализ проекта на наличие избыточных/дублирующих запросов к бэкенду. Выявлены и оптимизированы критичные проблемы.

## Найденные проблемы и решения

### 1. ✅ Исправлено: N+1 запросов в adminEnrichBloggersWithGender

**Проблема:** Для каждого блогера в списке делался отдельный запрос к `/blogger/public/${bloggerId}` только для получения поля `genderType`.

**Решение:**
- Добавлено кэширование `genderType` по ID блогера (TTL: 5 минут)
- Оптимизирована обработка батчей
- Добавлена документация с рекомендацией для бэкенда

**Файл:** `src/api/endpoints/admin.ts:737-855`

**Рекомендация бэкенду:**
Добавить поле `genderType` в ответ `/admin/blogger`, чтобы полностью исключить N+1 запросов.

### 2. ✅ Документировано: Двойной запрос в useBloggerProfile

**Проблема:** Сначала поиск через `getAllBloggers`, затем детальный запрос через `getBloggerById`.

**Анализ:**
Двойной запрос необходим, т.к.:
- API списка возвращает только одну платформу (не все)
- API списка не возвращает `topics`, `restrictedTopics`, множественные платформы
- API списка не возвращает полную информацию (drafts, statsFiles и т.д.)

**Решение:**
- Добавлена документация объясняющая необходимость двух запросов
- Добавлена рекомендация для бэкенда

**Файл:** `src/hooks/useBloggerProfile.ts:28-89`

**Рекомендация бэкенду:**
Добавить endpoint `GET /blogger/public/by-username/:username` для прямого получения детальной информации по username без предварительного поиска.

### 3. ✅ Проверено: useProfileLoader

**Статус:** Защищено проверками - запрос делается только если данных нет.

**Файл:** `src/hooks/profile/useProfileLoader.ts:90-127`

### 4. ✅ Проверено: BloggerContext

**Статус:** Защищено проверками состояния загрузки и наличия сессии.

**Файл:** `src/contexts/BloggerContext.tsx:99-153`

## Добавленные улучшения

### Логирование дублирующих запросов

Добавлен трекер запросов, который предупреждает о потенциально дублирующих запросах в development режиме.

**Файл:** `src/api/client.ts:32-105`

**Особенности:**
- Работает только в `DEV` режиме
- Отслеживает запросы с одинаковым endpoint, method и body
- Предупреждает если запрос повторяется быстрее чем за 1 секунду
- Выводит stack trace для отладки

### Кэширование genderType

Добавлено кэширование результатов запросов `genderType` для предотвращения повторных запросов в админской панели.

**Особенности:**
- TTL: 5 минут
- Автоматическая очистка устаревших записей
- Работает только для `adminEnrichBloggersWithGender`

## Рекомендации на будущее

### React Query / SWR

Для более продвинутого кэширования и управления состоянием запросов рекомендуется рассмотреть:

- **React Query** (`@tanstack/react-query`) - мощное решение для кэширования, синхронизации и обновления серверного состояния
- **SWR** - легковесная альтернатива от Vercel

**Преимущества:**
- Автоматическое кэширование запросов
- Deduplication запросов (одинаковые запросы объединяются)
- Автоматическая повторная валидация (stale-while-revalidate)
- Оптимистичные обновления
- Пагинация и бесконечная прокрутка из коробки

### Дальнейшие оптимизации бэкенда

1. **Добавить `genderType` в `/admin/blogger`**
   - Полностью устранит N+1 проблему
   - Уменьшит количество запросов с 50+ до 1

2. **Добавить `GET /blogger/public/by-username/:username`**
   - Устранит двойной запрос в `useBloggerProfile`
   - Упростит получение профиля по username

3. **Batch endpoints для массовых операций**
   - Например: `POST /blogger/public/gender-batch` для получения genderType для множества блогеров за один запрос

## Метрики улучшений

- **adminEnrichBloggersWithGender**: При повторных загрузках списка - 0 лишних запросов (благодаря кэшу)
- **useBloggerProfile**: Двойной запрос оправдан необходимостью полной информации, может быть оптимизирован через новый endpoint
- **Общее**: Добавлено логирование для отслеживания будущих проблем

## Заключение

Основные проблемы дублирования запросов выявлены и исправлены. Добавлено кэширование для критичных мест и логирование для отслеживания будущих проблем. Для полного устранения всех проблем требуется помощь бэкенда.
