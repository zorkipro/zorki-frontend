# Исправление логики тематик с учетом черновиков

## Проблема

Тематики и запрещенные тематики не учитывали черновики из `profileDraft`. При редактировании профиля пользователь мог изменить тематики, но они сохранялись только в черновик, а на странице редактирования отображались старые тематики из основных данных профиля.

## Причина

В `useProfileLoader.ts` функция `loadTopics` загружала тематики только из основных данных профиля (`localProfile.topics` и `localProfile.restrictedTopics`), полностью игнорируя черновики из `profileDraft.topics` и `profileDraft.restrictedTopics`.

### Детали проблемы:

1. **В `useProfileLoader.ts`**: `loadTopics` использовала только `localProfile.topics` и `localProfile.restrictedTopics`
2. **Игнорирование черновиков**: Не проверялись `apiProfile.profileDraft.topics` и `apiProfile.profileDraft.restrictedTopics`
3. **Неконсистентность**: Пользователь видел старые тематики вместо измененных в черновике

## Решение

### Добавление приоритета черновиков для тематик

**Файл:** `src/hooks/profile/useProfileLoader.ts`

Изменена логика загрузки тематик для учета черновиков:

```typescript
// ДО (неправильно):
const loadedTopics = localProfile.topics || [];
const loadedBannedTopics = localProfile.restrictedTopics || [];

// ПОСЛЕ (правильно):
// ПРИОРИТЕТ ЧЕРНОВИКАМ: если есть черновик профиля, используем тематики из него
const profileDraft = apiProfile.profileDraft;
const loadedTopics = profileDraft?.topics?.map(t => t.id) || localProfile.topics || [];
const loadedBannedTopics = profileDraft?.restrictedTopics?.map(t => t.id) || localProfile.restrictedTopics || [];
```

### Логика приоритета черновиков:

1. **Проверяем наличие черновика**: `apiProfile.profileDraft`
2. **Если есть черновик с тематиками**: Используем `profileDraft.topics` и `profileDraft.restrictedTopics`
3. **Если черновика нет или тематик нет**: Используем основные данные `localProfile.topics` и `localProfile.restrictedTopics`
4. **Конвертация в ID**: Черновики содержат объекты с `id`, поэтому используем `.map(t => t.id)`

## Результат

✅ **Тематики из черновиков отображаются** корректно на странице редактирования  
✅ **Запрещенные тематики из черновиков отображаются** корректно  
✅ **Консистентность** между черновиками и отображением  
✅ **Приоритет черновиков** над основными данными  
✅ **Обратная совместимость** сохранена

## Тестирование

### Сценарий 1: Редактирование тематик
1. Открыть форму редактирования профиля
2. Изменить тематики и сохранить (создается черновик)
3. Обновить страницу
4. **Ожидаемый результат:** Отображаются новые тематики из черновика

### Сценарий 2: Редактирование запрещенных тематик
1. Изменить запрещенные тематики
2. Сохранить изменения
3. **Ожидаемый результат:** Отображаются новые запрещенные тематики из черновика

### Сценарий 3: Комбинированное редактирование
1. Изменить тематики, запрещенные тематики и другие поля профиля
2. Сохранить все изменения
3. **Ожидаемый результат:** Все изменения отображаются корректно

### Сценарий 4: Отсутствие черновиков
1. Открыть профиль без черновиков
2. **Ожидаемый результат:** Отображаются основные тематики профиля

## Файлы изменений

1. `src/hooks/profile/useProfileLoader.ts` - добавлен приоритет черновиков для тематик

## Совместимость

- ✅ Обратная совместимость сохранена
- ✅ Существующие профили без черновиков работают как прежде
- ✅ Логика в `useProfileDrafts` не изменилась
- ✅ Все существующие функции (сохранение, отображение) работают как прежде

## Workflow для тематик с черновиками

1. **Пользователь редактирует тематики** → изменения сохраняются в `profileDraft`
2. **При загрузке страницы** → `loadTopics` проверяет наличие `profileDraft`
3. **Если есть черновик** → используются тематики из `profileDraft.topics` и `profileDraft.restrictedTopics`
4. **Если черновика нет** → используются основные тематики из профиля
5. **Конвертация в ID** → объекты тематик конвертируются в массив ID
6. **Отображение** → тематики отображаются в интерфейсе

## Преимущества

- **Консистентность**: Пользователь видит актуальные тематики из черновиков
- **Приоритет черновиков**: Черновики всегда имеют приоритет над основными данными
- **Простота**: Минимальные изменения в существующей логике
- **Надежность**: Работает для всех сценариев (с черновиками и без)
